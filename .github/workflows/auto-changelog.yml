name: Auto changelog

permissions:
  contents: write
  pull-requests: read

on:
  pull_request_target:
    types: [closed]

jobs:
  auto-changelog:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          fetch-depth: 0

      - name: Extract PR description
        id: extract-desc
        run: |
          echo "DESCRIPTION<<EOF" >> $GITHUB_OUTPUT
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}" \
            | jq -r '.body' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Parse and update changelog
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          AUTHOR: ${{ github.event.pull_request.user.login }}
          DESCRIPTION: ${{ steps.extract-desc.outputs.DESCRIPTION }}
        run: |
          python <<EOF
          import yaml
          import re
          from datetime import datetime, timezone
          import os
          import sys

          CHANGELOG_FILE = "Resources/Changelog/ChangelogDS14.yml"

          description = os.environ['DESCRIPTION']
          author = os.environ['AUTHOR']

          desc_clean = re.sub(r'<!--.*?-->', '', description, flags=re.DOTALL)

          if ':cl:' not in desc_clean:
              print("Изменений нет, пропуск (:cl:)")
              exit(0)

          sections = {
              'Добавлено': 'Add',
              'Удалено': 'Remove',
              'Изменено': 'Tweak',
              'Исправлено': 'Fix'
          }
          changes = []

          for title, type_key in sections.items():
              pattern = rf'- {title}:\s*(.*?)(?=\n- [^:]|$)'
              matches = re.findall(pattern, desc_clean, flags=re.DOTALL)

              for match in matches:
                  lines = [line.strip() for line in match.strip().split('\n') if line.strip()]
                  if not lines:
                      continue

                  message = ' '.join(lines)
                  message = re.sub(r'\s+', ' ', message).strip()

                  if message:
                      changes.append({
                          'type': type_key,
                          'message': message
                      })

          if not changes:
              print("Нет информации об изменениях")
              exit(0)

          if os.path.exists(CHANGELOG_FILE):
              with open(CHANGELOG_FILE, 'r', encoding='utf-8') as f:
                  try:
                      data = yaml.safe_load(f) or {}
                  except Exception as e:
                      print(f"Ошибка чтения {CHANGELOG_FILE}: {e}")
                      data = {}
          else:
              data = {}

          entries = data.get('Entries', [])
          max_id = max((entry['id'] for entry in entries), default=0)
          new_id = max_id + 1

          new_entry = {
              'id': new_id,
              'author': author,
              'time': datetime.now(timezone.utc).isoformat(),
              'changes': changes
          }

          entries.append(new_entry)
          data['Entries'] = entries

          with open(CHANGELOG_FILE, 'w', encoding='utf-8') as f:
              yaml.dump(
                  data,
                  f,
                  default_style=None,
                  default_flow_style=False,
                  allow_unicode=True,
                  sort_keys=False,
                  indent=2
              )

          print(f"Изменения могут быть записаны в {CHANGELOG_FILE}.")
          EOF


      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "Обновлён ченжлог #${{ github.event.pull_request.number }}"
          file_pattern: Resources/Changelog/ChangelogDS14.yml
          branch: ${{ github.event.pull_request.base.ref }}
