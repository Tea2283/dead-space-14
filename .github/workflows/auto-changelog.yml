name: Update changelog

permissions:
  contents: write

on:
  pull_request_target:
    types: [closed]

jobs:
  changelog:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout changelog branch
        uses: actions/checkout@v4
        with:
          ref: changelog
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract PR description
        id: extract
        run: |
          echo "DESCRIPTION<<EOF" >> $GITHUB_OUTPUT
          printf '%s\n' "${{ github.event.pull_request.body }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Parse PR description and update changelog
        env:
          DESCRIPTION: ${{ steps.extract.outputs.DESCRIPTION }}
          AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          python <<'EOF'
          import yaml, re, os
          from datetime import datetime, timezone

          CHANGELOG = "Resources/Changelog/ChangelogDS14.yml"

          desc = os.environ.get("DESCRIPTION", "")
          author = os.environ.get("AUTHOR", "")
          pr = os.environ.get("PR_NUMBER", "")

          # Убираем HTML-комментарии
          desc = re.sub(r'<!--.*?-->', '', desc, flags=re.DOTALL)

          if ":cl:" not in desc:
              print("Нет :cl: — пропуск")
              exit(0)

          sections = {
              "Добавлено": "Add",
              "Удалено": "Remove",
              "Изменено": "Tweak",
              "Исправлено": "Fix",
          }

          changes = []

          for title, type_key in sections.items():
              pattern = rf"- {title}:\s*(.*?)(?=\n- [^:]|$)"
              for block in re.findall(pattern, desc, flags=re.DOTALL):
                  lines = [
                      l.strip("- ").strip()
                      for l in block.splitlines()
                      if l.strip()
                  ]
                  if not lines:
                      continue
                  message = " ".join(lines)
                  message = re.sub(r"\s+", " ", message).strip()
                  if message:
                      changes.append({
                          "type": type_key,
                          "message": message
                      })

          if not changes:
              print("Изменения не найдены")
              exit(0)

          with open(CHANGELOG, "r", encoding="utf-8") as f:
              data = yaml.safe_load(f) or {}

          entries = data.get("Entries", [])

          last_id = max((e.get("id", 0) for e in entries), default=0)

          entries.append({
              "id": last_id + 1,
              "author": author,
              "time": datetime.now(timezone.utc).isoformat(),
              "pr": int(pr),
              "changes": changes
          })

          data["Entries"] = entries

          with open(CHANGELOG, "w", encoding="utf-8") as f:
              yaml.dump(
                  data,
                  f,
                  allow_unicode=True,
                  sort_keys=False,
                  indent=2
              )

          print("Changelog обновлён")
          EOF

      - name: Commit and push to changelog
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add Resources/Changelog/ChangelogDS14.yml

          if git diff --cached --quiet; then
            echo "Нет изменений для коммита"
            exit 0
          fi

          git commit -m "Changelog: PR #${{ github.event.pull_request.number }}"
          git pull --rebase origin changelog
          git push origin changelog

      - name: Create PR from changelog to master if not exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          REPO="${{ github.repository }}"
          OWNER="${{ github.repository_owner }}"
          HEAD="changelog"
          BASE="master"

          echo "Checking existing PR from $HEAD to $BASE..."

          EXISTING_PR=$(curl -s \
            -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/repos/$REPO/pulls?head=$OWNER:$HEAD&base=$BASE&state=open" \
            | jq '.[0] // empty')

          if [ -n "$EXISTING_PR" ]; then
            PR_NUMBER=$(echo "$EXISTING_PR" | jq -r '.number')
            echo "PR already exists: #$PR_NUMBER"
            exit 0
          fi

          echo "No PR found — creating new one"

          curl -s -X POST \
            -H "Authorization: token $GH_TOKEN" \
            -H "Content-Type: application/json" \
            "https://api.github.com/repos/$REPO/pulls" \
            -d "$(jq -n \
              --arg title "Changelog update" \
              --arg head "$HEAD" \
              --arg base "$BASE" \
              --arg body "Автоматически сгенерированный PR с обновлением changelog." \
              '{title:$title, head:$head, base:$base, body:$body}')"

          echo "PR created"

